<!DOCTYPE html>
<html lang="zh-cn">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="theme" content="hugo-academic">
  <meta name="generator" content="Hugo 0.41" />
  <meta name="author" content="Peng Zhao">
  <meta name="description" content="Post-doc in Geoecology">

  
  
  
    
  
  
    
    
    <link rel="stylesheet" href="/css/highlight.min.css">
    
  
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/academicons.min.css">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:400,700|Merriweather|Roboto+Mono">
  <link rel="stylesheet" href="/css/hugo-academic.css">
  

  <link rel="alternate" href="http://www.pzhao.org/index.xml" type="application/rss+xml" title="Peng Zhao">
  <link rel="feed" href="http://www.pzhao.org/index.xml" type="application/rss+xml" title="Peng Zhao">

  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/apple-touch-icon.png">

  <link rel="canonical" href="http://www.pzhao.org/zh/post/r-with-markdown2/">

  

  <title>用 markdown 的逻辑写 R 脚本注释（2） | Peng Zhao</title>

</head>
<body id="top" data-spy="scroll" data-target="#navbar-main" data-offset="71">

<nav class="navbar navbar-default navbar-fixed-top" id="navbar-main">
  <div class="container">

    
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
              data-target=".navbar-collapse" aria-expanded="false">
        <span class="sr-only">切换导航</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/zh/">Peng Zhao</a>
    </div>

    
    <div class="collapse navbar-collapse">

      
      <ul class="nav navbar-nav navbar-right">
        

        

        <li class="nav-item">
          <a href="/zh/#about">
            
            <span>关于</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/zh/tags/news">
            
            <span>新闻</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/zh/tags/post">
            
            <span>日志</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/zh/publication">
            
            <span>论文</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/zh/talk">
            
            <span>报告</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/zh/#projects">
            
            <span>项目</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/zh/#teaching">
            
            <span>教学</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/zh/#unclassified">
            
            <span>其他</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="https://cse.google.com/cse/publicurl?cx=006346710622437628329:nxozn9fijm0">
            
            <span>搜索</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/en">
            
            <span>EN</span>
          </a>
        </li>

        
        
      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  

  <div class="article-container">
    <h1 itemprop="name">用 markdown 的逻辑写 R 脚本注释（2）</h1>
    

<div class="article-metadata">

  <span class="article-date">
    <time datetime="2018-11-16 00:00:00 &#43;0000 UTC" itemprop="datePublished">
      Fri, Nov 16, 2018
    </time>
  </span>

  
  
  
  

  
  
  
  <span class="article-tags">
    <i class="fa fa-tags"></i>
    
    <a href="/zh/tags/post">post</a
    >
    
  </span>
  
  

  
  
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=http%3a%2f%2fwww.pzhao.org%2fzh%2fpost%2fr-with-markdown2%2f"
         target="_blank">
        <i class="fa fa-facebook"></i>
      </a>
    </li>
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=%e7%94%a8%20markdown%20%e7%9a%84%e9%80%bb%e8%be%91%e5%86%99%20R%20%e8%84%9a%e6%9c%ac%e6%b3%a8%e9%87%8a%ef%bc%882%ef%bc%89&amp;url=http%3a%2f%2fwww.pzhao.org%2fzh%2fpost%2fr-with-markdown2%2f"
         target="_blank">
        <i class="fa fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2fwww.pzhao.org%2fzh%2fpost%2fr-with-markdown2%2f&amp;title=%e7%94%a8%20markdown%20%e7%9a%84%e9%80%bb%e8%be%91%e5%86%99%20R%20%e8%84%9a%e6%9c%ac%e6%b3%a8%e9%87%8a%ef%bc%882%ef%bc%89"
         target="_blank">
        <i class="fa fa-linkedin"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=http%3a%2f%2fwww.pzhao.org%2fzh%2fpost%2fr-with-markdown2%2f&amp;title=%e7%94%a8%20markdown%20%e7%9a%84%e9%80%bb%e8%be%91%e5%86%99%20R%20%e8%84%9a%e6%9c%ac%e6%b3%a8%e9%87%8a%ef%bc%882%ef%bc%89"
         target="_blank">
        <i class="fa fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=%e7%94%a8%20markdown%20%e7%9a%84%e9%80%bb%e8%be%91%e5%86%99%20R%20%e8%84%9a%e6%9c%ac%e6%b3%a8%e9%87%8a%ef%bc%882%ef%bc%89&amp;body=http%3a%2f%2fwww.pzhao.org%2fzh%2fpost%2fr-with-markdown2%2f">
        <i class="fa fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


  

</div>

    <div class="article-style" itemprop="articleBody">
      

<p><a href="http://www.pzhao.org/zh/post/r-with-markdown2/" target="_blank">上回</a>我抱怨没有现成的函数直接把 .R 脚本转换成 .Rmd 文档，于是自作聪明写了一个，结果很快 yihui 就留言说，有啊，<code>knitr::spin()</code> 就可以。我就去研究了一下这个函数，发现比我写的那个要漂亮得多。</p>

<p>我的心情很复杂。</p>

<p>话说诗仙李白当年游山玩水，看见什么就写什么，留下的诗篇个个照耀千古。有一天，他来到了黄鹤楼，照例诗兴大发，正待提笔，突然看见了墙上有前辈崔颢题写的一首七律：</p>

<blockquote>
<p>昔人已乘黄鹤去，此地空余黄鹤楼。</p>

<p>黄鹤一去不复返，白云千载空悠悠。</p>

<p>晴川历历汉阳树，芳草萋萋鹦鹉洲。</p>

<p>日暮乡关何处是，烟波江上使人愁。</p>
</blockquote>

<p>李白又惊又喜，提笔想写，却发现根本写不出来。又好笑又好气，李白终于憋出了四句：</p>

<blockquote>
<p>一拳捶碎黄鹤楼，一脚踢翻鹦鹉洲。</p>

<p>眼前有景道不得，崔颢题诗在上头。</p>
</blockquote>

<p>嗯，就是那种拳打脚踢的冲动。</p>

<p>我常常懊恼没有时间做调研，如果事先找到巨人，再爬到他肩上会看得有多远。现在，巨人来了，我打算爬上去看一看。</p>

<h2 id="knitr-spin-的巨人之肩"><code>knitr::spin()</code>的巨人之肩</h2>

<p><code>knitr::spin()</code> 的<a href="https://yihui.name/knitr/demo/stitch/" target="_blank">官方文档</a> 给出了一个<a href="https://github.com/yihui/knitr/blob/master/inst/examples/knitr-spin.R" target="_blank">示例</a>，详细介绍了用 markdown 的逻辑来写 .R 代码的策略，而这个示例本身就是个可以转换成 .Rmd 文档的 .R 脚本。转换规则有六条：</p>

<table>
<thead>
<tr>
<th>.R 脚本书写规则</th>
<th><code>spin(.R脚本)</code>得到的 .Rmd 文档</th>
</tr>
</thead>

<tbody>
<tr>
<td>1. &ldquo;<code>#'</code> &ldquo; 开头的注释行</td>
<td>成为正文文字</td>
</tr>

<tr>
<td>2. &ldquo;<code>#+</code>&rdquo; 开头的注释行</td>
<td>成为代码块的选项（chunk options）</td>
</tr>

<tr>
<td>3. 双重花括号（如<code>{{mean(x)}}</code>）</td>
<td>成为行内代码（如<code>`r mean(x)`</code>）</td>
</tr>

<tr>
<td>4. 代码行</td>
<td>前后添加一对连续的三个反引号，成为代码块</td>
</tr>

<tr>
<td>5. &ldquo;<code>#</code>&rdquo; 开头的普通注释行</td>
<td>保留不变，成为代码块里的注释</td>
</tr>

<tr>
<td>6. <code># /*</code> 与 <code># */</code> 之间的部分</td>
<td>跳过，不进入 .Rmd</td>
</tr>
</tbody>
</table>

<p>只要按上表的第一列规则写 .R  代码，就可以一键转换成 .Rmd 文档。这个规则高明在哪里呢？</p>

<ol>
<li>完全没有破坏 R 代码的基本规则。</li>
<li>常用的格式基本都囊括了。</li>
<li>照这个规则写的 R 代码赏心悦目。</li>
<li>够简单。前三条规则可以称为“约法三章”。照这三条来写注释就行了，第 4 第 5 条不用管，第 6 条很少用。</li>
</ol>

<p>我用这个规则写了一个脚本，成功转换，欢喜得紧。</p>

<p>然而，唯一的不完美在于：章节标题。</p>

<h2 id="mindr-r2rmd-将-r-脚本转换成-rmd-文档"><code>mindr::r2rmd()</code>：将 .R 脚本转换成 .Rmd 文档</h2>

<p>我常常用 RStudio 的快捷键 ctrl + shift + r 在 .R 脚本里生成下面这样格式的章节标签：</p>

<pre><code class="language-R"># Section label ------------
</code></pre>

<p>这样的话，在 RStudio 里会以大纲视图来显示章节标签，方便跳转。大纲视图在两处显示，即下图的右侧栏和底部按钮：</p>

<p><img src="https://cdn.steemitimages.com/DQmaUZ5poerko6956f4j6FvEAmzo2GRdb231aQ8GxmpBKUD/outline.jpg" alt="outline.jpg" /></p>

<p>很容易联想到，这个标签相当于 .Rmd 里的章节标题。如果在 .R 向 .Rmd 转换的时候，能把这个映射过去就好了。</p>

<p>这好办，在 <code>knitr::spin()</code> 的基础上，我新写了个 <code>mindr::r2rmd()</code> 函数，支持下面这条规则：</p>

<table>
<thead>
<tr>
<th>.R 脚本书写规则</th>
<th><code>spin(.R脚本)</code>得到的 .Rmd 文档</th>
</tr>
</thead>

<tbody>
<tr>
<td>7. &ldquo;<code>#=</code> &ldquo; 开头的注释行</td>
<td>成为章节标题</td>
</tr>
</tbody>
</table>

<p>例如，<code>#= ## Section 1.1 ----</code> 经过 <code>mindr::r2rmd()</code>转换后，去掉了头尾，得到的是<code>## Section 1.1</code>。</p>

<p>也许有人会问：为啥不直接用约法三章的第一条，<code>#' ## Section 1.1 ----</code>来写章节标签呢？少一条规则不更好吗？</p>

<p>我原先也是这么想的，后来发现，<code>#'</code> 开头的章节标签在RStudio 是不会以大纲视图来显示的。</p>

<p>这个问题我觉得可以择吉日提交给 RStudio。目前暂时按规则 7 行事吧。</p>

<p>这里有一个<a href="https://github.com/pzhaonet/mindr/blob/master/inst/examples/r/r2rmd.R" target="_blank">按上述 7 条规则写的 .R 脚本示例</a>。</p>

<h2 id="mindr-rmd2r-将-rmd-文档转换成-r-脚本"><code>mindr::rmd2r()</code>: 将 .Rmd 文档转换成 .R 脚本</h2>

<p>上回说过，<code>knitr::purl()</code> 可以将 .Rmd 文档转换成 .R 脚本。乍一看以为它和 <code>knitr::spin()</code>互为反函数，但是仔细一看，并非如此，例如 chunk options 和 {{code}} 就没按原来的格式还原回去。现在，一个 .R 脚本经过上面的 <code>mindr::r2rmd()</code> 一折腾，得到的 .Rmd 更是没法原样转换回到原来的 .R 脚本了。</p>

<p>怎么办？我新写了个 <code>mindr::rmd2r()</code>函数。它跟 <code>mindr::r2rmd()</code> 互为逆操作，目前看算是比较严格的互换：</p>

<table>
<thead>
<tr>
<th>.Rmd 文档格式</th>
<th><code>r2rmd(.Rmd文档)</code>得到的 .R 脚本</th>
</tr>
</thead>

<tbody>
<tr>
<td>1. 正文文字</td>
<td>成为&rdquo;<code>#'</code> &ldquo; 开头的注释行</td>
</tr>

<tr>
<td>2. 代码块的选项（chunk options）</td>
<td>成为&rdquo;<code>#+</code>&rdquo; 开头的注释行</td>
</tr>

<tr>
<td>3. 行内代码（如<code>`r mean(x)`</code>）</td>
<td>成为双重花括号（如<code>{{mean(x)}}</code>）</td>
</tr>

<tr>
<td>4. 代码块</td>
<td>成为代码行</td>
</tr>

<tr>
<td>5. 代码块里的注释</td>
<td>成为 &ldquo;<code>#</code>&rdquo; 开头的普通注释行</td>
</tr>

<tr>
<td>6. <code>&lt;!--</code> 和<code>--&gt;</code>包围的内容</td>
<td>忽略，不进入 .R 脚本</td>
</tr>

<tr>
<td>7. 章节标题</td>
<td>成为 &ldquo;<code>#=</code>&rdquo; 开头、&rdquo;<code>----</code>&ldquo;结尾的章节标签</td>
</tr>
</tbody>
</table>

<p>跟前面的表格算是一一对应。</p>

<p>这样一来，一对儿 .R 脚本和 .Rmd 文档，只需维护其中任意一个，就能直接更新到另一个里了。</p>

<h2 id="mindr-r2mm-和-mindr-mm2r-r-脚本和思维导图的相互转换"><code>mindr::r2mm()</code>和<code>mindr::mm2r()</code>：.R 脚本和思维导图的相互转换</h2>

<p>上面说的，纯属狗拿耗子多管闲事。mindr 本来是做思维导图的。</p>

<p>不过，既然我们按上面表格约定的规则来写 .R 脚本，那么先<code>mindr::r2rmd()</code>再<code>mindr::md2mm()</code>，两步就可以把脚本里的大纲提取出来，生成思维导图了。我把这两步打了个包，新写了函数叫 <code>r2mm()</code>，直接从 .R 脚本生成思维导图。当然，反过来就是 <code>mm2r()</code>，从思维导图来创建一个 .R 脚本，以符合上面约定的规则。</p>

<p>天下终于太平了。</p>

<p><img src="https://github.com/pzhaonet/mindr/raw/master/showcase/mindr_concept_1.1.8.png" alt="" /></p>

    </div>
  </div>

</article>

<div class="container">
  <nav>
  <ul class="pager">
    
    <li class="previous"><a href="http://www.pzhao.org/zh/post/jinyong/"><span
      aria-hidden="true">&larr;</span> 金庸早已远逝，我辈江湖犹存</a></li>
    

    
  </ul>
</nav>

</div>

<div class="article-container">
  
<section id="comments">
  <div id="disqus_thread">
    <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "pzhao" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
</section>


</div>

<footer class="site-footer">
  <div class="container">
    <p class="powered-by">

      &copy; 2017 Peng Zhao &middot; 

      Powered by the <a href="https://github.com/gcushen/hugo-academic" target="_blank">Academic
      theme</a> for <a href="http://gohugo.io" target="_blank">Hugo</a>.

      <span class="pull-right" aria-hidden="true">
        <a href="#" id="back_to_top">
          <span class="button_icon">
            <i class="fa fa-chevron-up fa-2x"></i>
          </span>
        </a>
      </span>

    </p>
  </div>
</footer>

    <script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.4/TweenMax.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/gsap/latest/plugins/ScrollToPlugin.min.js"></script>
    <script src="/js/jquery-1.12.3.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/isotope.pkgd.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.1/imagesloaded.pkgd.min.js"></script>
    <script src="/js/hugo-academic.js"></script>
    

    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-99744900-1', 'auto');
        ga('send', 'pageview');

         
        var links = document.querySelectorAll('a');
        Array.prototype.map.call(links, function(item) {
            if (item.host != document.location.host) {
                item.addEventListener('click', function() {
                    var action = item.getAttribute('data-action') || 'follow';
                    ga('send', 'event', 'outbound', action, item.href);
                });
            }
        });
    </script>
    

    
    
      
      <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>

      

      

      <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
    </script>
    <script async src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_CHTML"></script>
    

  </body>
</html>

